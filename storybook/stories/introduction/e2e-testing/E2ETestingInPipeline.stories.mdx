import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Introduction/E2E тестирование/Тестирование в пайплайне"
      parameters={{
        previewTabs: {
          canvas: {
            hidden: true,
          },
        },
      }} />

# E2E тестирование / Тестирование в пайплайне

**Содержание:**
+ [Флоу](#флоу)
+ [Джобы](#джобы)
  * [e2e:test:ssr](#e2etestssr)
  * [e2e:test:screenshot](#e2etestscreenshot)
  * [e2e:push-screenshots](#e2epush-screenshots)
  * [e2e:merge-screenshots](#e2emerge-screenshots)
+ [Кейсы](#кейсы)
  * [Общие](#общие)
  * [Скриншот тесты](#скриншот-тесты)
+ [Отчеты](#отчеты)
<br/>

## Флоу
<img src="/img/introduction/e2e-testing/e2e-screenshot-tests-pipeline.png" alt="" width="800" />

**Редактирование**:
* <a href="/img/introduction/e2e-testing/e2e-screenshot-tests-pipeline.png" download>Файл</a>
* <a href="https://app.diagrams.net/">Редактор</a>

## Джобы

### `e2e:test:ssr`

Тесты работы компонентов в ssr режиме. Проверяет отсутствие клиентских/серверных ошибок.

### `e2e:test:screenshot`

Скриншот тесты компонентов. Проверяет соответствие актуального состояния компонентов с их baseline.

### `e2e:push-screenshots`

Апрув изменений компонентов, приведших к падению скриншот тестов. Прожимается вручную и только членами команды ui-kit.
После успешной загрузки изменений автоматически перезапускает все упавшие скриншот тесты.

### `e2e:merge-screenshots`

Сливает скриншоты подтвержденных изменений компонентов из **release** ветки в **master** ветку в *s3* хранилище.

## Кейсы

### Общие

**1. Тесты упали, но я не причем**

Такое случается, сервисы для тестирования не 100% надежны. Перейдите на детальную страницы джобы и посмотрите в логах
на ход выполнения. Если вы видите:
* ошибки связанные с подключением к браузеру<br/>
<img src="/img/introduction/e2e-testing/e2e-service-error.png" alt="" width="600" />
* ошибки в компонентах, которые ваши изменения никак не могли затронуть<br/>
<img src="/img/introduction/e2e-testing/e2e-component-error.png" alt="" width="600" />

то попробуйте перезапустить джобу:
<img src="/img/introduction/e2e-testing/e2e-job-retry.png" alt="" width="800" />

В случае, если ошибка повторяется, призовите члена команды ui-kit.

### Скриншот тесты

**1. Нет baseline (самый первый релиз)**
1. Катится релиз
2. Запускается релизный пайплайн
3. Скриншот тесты падают, т.к. нет baseline и не с чем сравнивать
4. Призывается член команды ui-kit, чтобы подтвердить заливку скриншотов в *s3*, прожав джобу **e2e:push-screenshots**
5. Автоматически перезапускаются упавшие скриншот тесты и успешно проходят, т.к. теперь есть baseline
6. Жмется **ready to prod**
7. В master пайплайне джоба **e2e:merge-screenshots** мерджит **release** ветку в **master**
8. Теперь есть **master** скриншоты
9. Релиз завершен

**2. Внешний вид существующих компонентов не изменился**
1. Катится релиз
2. Запускается релизный пайплайн
3. Скриншот тесты успешно проходят, т.к. внешний вид компонентов не изменился
4. Жмется **ready to prod**
5. В master пайплайне джоба **e2e:merge-screenshots** ничего не делает
6. Релиз завершен

**3. Внешний вид существующих компонентов изменился**
1. Катится релиз
2. Запускается релизный пайплайн
3. Скриншот тесты падают, т.к. внешний вид компонента изменился
4. Призывается член команды ui-kit, чтобы подтвердить изменение компонента, прожав джобу **e2e:push-screenshots**
5. Автоматически перезапускаются упавшие скриншот тесты и успешно проходят, т.к. baseline изменился на подтвержденный
6. Жмется **ready to prod**
7. В master пайплайне джоба **e2e:merge-screenshots** мерджит **release** ветку в **master**
8. Релиз завершен

**4. Добавление нового компонента**
* Аналогично кейсу 1.

**5. Удаление существующего компонента**
* Аналогично кейсу 2.

## Отчеты

В конце любой джобы запускающей какой-либо e2e тест, как например **e2e:test:ssr** или **e2e:test:screenshot**, будет
выведена ссылка по которой будут доступны отчеты.

<img src="/img/introduction/e2e-testing/allure-reporter-pipeline-report.png" alt="" height="400" />

*[Подробнее об инструменте создания и настройке отчетов Allure Reporter](./?path=/story/introduction-e2e-тестирование-отчеты--page)
